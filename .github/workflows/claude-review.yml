name: Claude Review

# Runs an automated Claude Code review on pull requests that move code between
# the two gated branch transitions in this repo:
#
#   dev  →  stage   (integration gate)
#   stage →  main   (production gate)
#
# Feature-branch PRs are intentionally excluded to keep token usage low.
# Manual runs (workflow_dispatch) bypass the branch filter for testing.
#
# Required secret: CLAUDE_CODE_OAUTH_TOKEN (added automatically by the Claude GitHub App)
# Install the app at: github.com/apps/claude  — or use ANTHROPIC_API_KEY as a fallback.

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Pre-filter to PRs targeting stage or main; the job-level `if` below
    # further restricts to the exact source→target pairs we care about.
    branches: [stage, main]
  workflow_dispatch:
    inputs:
      head_sha:
        description: "Head commit SHA to check out (leave blank to use branch HEAD)"
        required: false
        default: ""

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest

    # Only run on the two branch transitions we care about.
    # workflow_dispatch bypass lets you trigger a review manually for testing.
    if: |
      (github.base_ref == 'stage' && github.head_ref == 'dev') ||
      (github.base_ref == 'main'  && github.head_ref == 'stage') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          # PR triggers supply pull_request.head.sha (pinned to the reviewed commit).
          # workflow_dispatch supplies inputs.head_sha when a specific commit is intended;
          # falls back to github.sha (branch HEAD) for untargeted manual runs.
          ref: ${{ github.event.pull_request.head.sha || inputs.head_sha || github.sha }}
          fetch-depth: 0

      # ── API key guard ──────────────────────────────────────────────────────
      - name: Check Claude auth secret
        id: keycheck
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY:       ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Accept either the GitHub App OAuth token or a direct API key.
          if [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ] && [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "Neither CLAUDE_CODE_OAUTH_TOKEN nor ANTHROPIC_API_KEY is set."
            exit 1
          fi

      - name: Comment when auth secret is missing
        if: steps.keycheck.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "⚠️ **Claude review skipped** — no auth secret is configured.",
                "",
                "Install the [Claude GitHub App](https://github.com/apps/claude) to get `CLAUDE_CODE_OAUTH_TOKEN`,",
                "or add `ANTHROPIC_API_KEY` manually at **Settings → Secrets and variables → Actions**.",
              ].join("\n"),
            });

      - name: Fail when auth secret is missing
        if: steps.keycheck.outcome != 'success'
        run: exit 1

      # ── Build review prompt ────────────────────────────────────────────────
      - name: Build review prompt
        if: steps.keycheck.outcome == 'success'
        env:
          BASE_REF:  ${{ github.base_ref }}
          HEAD_REF:  ${{ github.head_ref }}
          PR_TITLE:  ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 - <<'PY'
          import os
          from pathlib import Path

          base      = Path(".github/claude/prompts/review.md").read_text()
          base_ref  = os.environ.get("BASE_REF",  "")
          head_ref  = os.environ.get("HEAD_REF",  "")
          pr_title  = os.environ.get("PR_TITLE",  "")
          pr_number = os.environ.get("PR_NUMBER", "")

          prompt = "\n".join([
              base,
              "",
              "---",
              "",
              f"You are reviewing **PR #{pr_number}: {pr_title}**",
              f"This PR merges `{head_ref}` into `{base_ref}`.",
              "",
              "Use the Read, Glob, and Grep tools to inspect changed or related files as needed,",
              "then post your structured review as a single comment on this PR.",
          ])

          github_env = os.environ.get("GITHUB_ENV", "")
          if github_env:
              with open(github_env, "a") as f:
                  f.write("CLAUDE_REVIEW_PROMPT<<HEREDOC_SENTINEL\n")
                  f.write(prompt)
                  f.write("\nHEREDOC_SENTINEL\n")
          PY

      # ── Run Claude review ──────────────────────────────────────────────────
      - name: Run Claude review
        if: steps.keycheck.outcome == 'success'
        uses: anthropics/claude-code-action@v1
        with:
          # GitHub App OAuth token takes priority; falls back to direct API key.
          anthropic_api_key:       ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token:            ${{ secrets.GITHUB_TOKEN }}
          # Read-only tools: Claude inspects code but does not modify files.
          allowed_tools:           "Read,Glob,Grep"
          direct_prompt:           ${{ env.CLAUDE_REVIEW_PROMPT }}
