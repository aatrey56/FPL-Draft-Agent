name: Claude Review

# Runs an automated Claude Code review on pull requests that move code between
# the two gated branch transitions in this repo:
#
#   dev  →  stage   (integration gate)
#   stage →  main   (production gate)
#
# Feature-branch PRs are intentionally excluded to keep token usage low.
# Manual runs (workflow_dispatch) bypass the branch filter for testing.
#
# Required secret: ANTHROPIC_API_KEY
# Set it at: Settings → Secrets and variables → Actions → New repository secret

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Pre-filter to PRs targeting stage or main; the job-level `if` below
    # further restricts to the exact source→target pairs we care about.
    branches: [stage, main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest

    # Only run on the two branch transitions we care about.
    # workflow_dispatch bypass lets you trigger a review manually for testing.
    if: |
      (github.base_ref == 'stage' && github.head_ref == 'dev') ||
      (github.base_ref == 'main'  && github.head_ref == 'stage') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      # ── API key guard ──────────────────────────────────────────────────────
      - name: Check Anthropic API key
        id: keycheck
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is not set."
            exit 1
          fi

      - name: Comment when API key is missing
        if: steps.keycheck.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "⚠️ **Claude review skipped** — `ANTHROPIC_API_KEY` is not configured.",
                "",
                "Add it at **Settings → Secrets and variables → Actions → New repository secret**.",
              ].join("\n"),
            });

      - name: Fail when API key is missing
        if: steps.keycheck.outcome != 'success'
        run: exit 1

      # ── Build review prompt ────────────────────────────────────────────────
      - name: Build review prompt
        if: steps.keycheck.outcome == 'success'
        env:
          BASE_REF:  ${{ github.base_ref }}
          HEAD_REF:  ${{ github.head_ref }}
          PR_TITLE:  ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 - <<'PY'
          import os
          from pathlib import Path

          base      = Path(".github/claude/prompts/review.md").read_text()
          base_ref  = os.environ.get("BASE_REF",  "")
          head_ref  = os.environ.get("HEAD_REF",  "")
          pr_title  = os.environ.get("PR_TITLE",  "")
          pr_number = os.environ.get("PR_NUMBER", "")

          prompt = "\n".join([
              base,
              "",
              "---",
              "",
              f"You are reviewing **PR #{pr_number}: {pr_title}**",
              f"This PR merges `{head_ref}` into `{base_ref}`.",
              "",
              "Use the Read, Glob, and Grep tools to inspect changed or related files as needed,",
              "then post your structured review as a single comment on this PR.",
          ])

          github_env = os.environ.get("GITHUB_ENV", "")
          if github_env:
              with open(github_env, "a") as f:
                  f.write("CLAUDE_REVIEW_PROMPT<<HEREDOC_SENTINEL\n")
                  f.write(prompt)
                  f.write("\nHEREDOC_SENTINEL\n")
          PY

      # ── Run Claude review ──────────────────────────────────────────────────
      - name: Run Claude review
        if: steps.keycheck.outcome == 'success'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token:      ${{ secrets.GITHUB_TOKEN }}
          # Read-only tools: Claude inspects code but does not modify files.
          allowed_tools:     "Read,Glob,Grep"
          direct_prompt:     ${{ env.CLAUDE_REVIEW_PROMPT }}
