name: Codex Issue Agent

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codex-issue:
    if: >-
      github.event.issue.pull_request == null &&
      (
        contains(github.event.comment.body, 'codex') ||
        contains(github.event.comment.body, 'Codex') ||
        contains(github.event.comment.body, 'CODEX')
      ) &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Check commenter permissions
        id: perm
        uses: actions/github-script@v7
        with:
          script: |
            const user = context.payload.comment.user.login;
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: user,
            });
            const allowed = ["admin", "maintain", "write"].includes(data.permission);
            core.setOutput("allowed", allowed ? "true" : "false");
            core.setOutput("permission", data.permission);
      - name: Reject if no write access
        if: steps.perm.outputs.allowed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const user = context.payload.comment.user.login;
            const perm = "${{ steps.perm.outputs.permission }}";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${user} you need write access to trigger Codex. Current permission: ${perm}.`,
            });
      - name: Check OpenAI API key
        if: steps.perm.outputs.allowed == 'true'
        id: keycheck
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is not set."
            exit 1
          fi
      - name: Comment when OpenAI API key is missing
        if: steps.keycheck.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "Codex could not run because OPENAI_API_KEY is not configured in repo secrets.",
            });
      - name: Checkout
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch base branch
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        run: git fetch origin dev --depth=1
      - name: Set up Go
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/mcp-server/go.mod
      - name: Set up Python
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/backend/requirements.txt
          pip install ruff pytest
          (cd apps/mcp-server && go mod download)
      - name: Create work branch
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        run: |
          BRANCH="codex/issue-${{ github.event.issue.number }}-${{ github.run_id }}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"
          git checkout -b "$BRANCH"
      - name: Build Codex prompt
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          
          base = Path(".github/codex/prompts/issue.md").read_text()
          issue_title = os.environ.get("ISSUE_TITLE", "")
          issue_body = os.environ.get("ISSUE_BODY", "")
          comment_body = os.environ.get("COMMENT_BODY", "")
          
          prompt = (
              f"{base}\n\n"
              f"Issue title:\n{issue_title}\n\n"
              f"Issue body:\n{issue_body}\n\n"
              f"Triggering comment:\n{comment_body}\n"
          )
          Path("/tmp/codex-issue-prompt.md").write_text(prompt)
          PY
      - name: Run Codex
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: /tmp/codex-issue-prompt.md
      - name: Apply Codex patch
        if: steps.perm.outputs.allowed == 'true' && steps.keycheck.outcome == 'success'
        id: apply
        run: |
          printf '%s' "${{ steps.codex.outputs.result }}" > /tmp/codex.patch
          if [ ! -s /tmp/codex.patch ]; then
            echo "Codex returned empty output."
            exit 1
          fi
          if grep -q '^NO_CHANGES' /tmp/codex.patch; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git apply --whitespace=fix /tmp/codex.patch
          if [ -z "$(git status --porcelain)" ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
      - name: Comment when no changes are needed
        if: steps.apply.outputs.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "Codex ran but found no changes to make.",
            });
      - name: Run preflight
        if: steps.apply.outputs.no_changes != 'true'
        id: preflight
        continue-on-error: true
        run: scripts/preflight.sh | tee /tmp/preflight.log
      - name: Build retry prompt (tests failed)
        if: steps.preflight.outcome != 'success' && steps.apply.outputs.no_changes != 'true'
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          
          base = Path(".github/codex/prompts/issue.md").read_text()
          issue_title = os.environ.get("ISSUE_TITLE", "")
          issue_body = os.environ.get("ISSUE_BODY", "")
          comment_body = os.environ.get("COMMENT_BODY", "")
          log = Path("/tmp/preflight.log").read_text()
          
          prompt = (
              f"{base}\n\n"
              "The previous changes failed preflight. Fix the failures and output a new patch.\n\n"
              f"Issue title:\n{issue_title}\n\n"
              f"Issue body:\n{issue_body}\n\n"
              f"Triggering comment:\n{comment_body}\n\n"
              "Preflight log:\n"
              f"{log}\n"
          )
          Path("/tmp/codex-issue-retry.md").write_text(prompt)
          PY
      - name: Run Codex retry
        if: steps.preflight.outcome != 'success' && steps.apply.outputs.no_changes != 'true'
        id: codex_retry
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: /tmp/codex-issue-retry.md
      - name: Apply retry patch
        if: steps.preflight.outcome != 'success' && steps.apply.outputs.no_changes != 'true'
        run: |
          printf '%s' "${{ steps.codex_retry.outputs.result }}" > /tmp/codex-retry.patch
          if [ ! -s /tmp/codex-retry.patch ]; then
            echo "Codex retry returned empty output."
            exit 1
          fi
          if grep -q '^NO_CHANGES' /tmp/codex-retry.patch; then
            echo "Retry returned NO_CHANGES."
            exit 1
          fi
          git apply --whitespace=fix /tmp/codex-retry.patch
      - name: Run preflight (retry)
        if: steps.preflight.outcome != 'success' && steps.apply.outputs.no_changes != 'true'
        id: preflight_retry
        continue-on-error: true
        run: scripts/preflight.sh | tee /tmp/preflight-retry.log
      - name: Comment on failing preflight
        if: |
          steps.apply.outputs.no_changes != 'true' &&
          (steps.preflight.outcome != 'success' && steps.preflight_retry.outcome != 'success')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = fs.existsSync("/tmp/preflight-retry.log")
              ? "/tmp/preflight-retry.log"
              : "/tmp/preflight.log";
            const log = fs.readFileSync(path, "utf8");
            const truncated = log.length > 6000 ? `${log.slice(0, 6000)}\n... (truncated)` : log;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Preflight failed. Codex did not open a PR.\n\n\`\`\`\n${truncated}\n\`\`\``,
            });
      - name: Commit changes
        if: |
          steps.apply.outputs.no_changes != 'true' &&
          (steps.preflight.outcome == 'success' || steps.preflight_retry.outcome == 'success')
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 1
          fi
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"
          git add -A
          git commit -m "codex: resolve issue #${{ github.event.issue.number }}"
          git push origin "$BRANCH"
      - name: Open PR
        if: |
          steps.apply.outputs.no_changes != 'true' &&
          (steps.preflight.outcome == 'success' || steps.preflight_retry.outcome == 'success')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const branch = process.env.BRANCH;
            const { execSync } = require("child_process");
            const files = execSync("git diff --name-only origin/dev...HEAD").toString().trim();
            const fileLines = files ? files.split("\n").map((f) => `- ${f}`).join("\n") : "- (no file list)";
            const body = [
              "## Summary",
              `- Issue #${issueNumber}: ${issueTitle}`,
              "- Files changed:",
              fileLines,
              "",
              "## Tests",
              "- scripts/preflight.sh",
            ].join("\n");
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Codex: ${issueTitle} (#${issueNumber})`,
              head: branch,
              base: "dev",
              body,
              draft: false,
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `PR opened: ${pr.data.html_url}`,
            });
